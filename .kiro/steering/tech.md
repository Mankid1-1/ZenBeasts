---
inclusion: always
---

# Tech Stack & Development Guidelines

## Core Stack

- **Blockchain**: Solana with Anchor Framework 0.29.0
- **Program**: Rust with Anchor macros (`anchor-lang`, `anchor-spl`, `mpl-token-metadata` 3.2.0)
- **Frontend**: Next.js 14 App Router + React 18 + TypeScript (strict mode)
- **API**: Express.js with ES modules (`"type": "module"` in package.json)
- **State**: Zustand for client state, Solana accounts for on-chain state
- **Wallet**: @solana/wallet-adapter-react with multi-wallet support

## Architecture Patterns

### Rust/Anchor Program
- One instruction per file in `programs/zenbeasts/src/instructions/`
- All instruction handlers return `Result<()>` and emit events
- Use `#[derive(Accounts)]` for account validation with constraints
- PDAs follow seed patterns: `[b"beast", mint.key()]` or `[b"config"]`
- State structs use `#[account]` and `#[derive(InitSpace)]` for space calculation
- Custom errors defined in `errors.rs` with `#[error_code]`
- Helper functions in `utils/` module (e.g., trait generation, rarity calculation)

### TypeScript/Frontend
- One custom hook per program instruction (e.g., `useMintBeast`, `useActivity`)
- `useProgram` hook provides program instance and connection to all other hooks
- Components organized by feature: `components/beast/`, `components/wallet/`
- Functional components only, no class components
- Explicit return types on all functions
- IDL imported from `frontend/src/lib/anchor/idl.json` (generated by `anchor build`)

### API
- ES modules syntax (`import`/`export`, not `require`)
- Simple REST endpoints for IDL serving and health checks
- Redis caching with `ioredis` for performance

## Code Style Rules

### Rust
- snake_case for functions, variables, modules
- PascalCase for structs, enums, traits
- Use `msg!()` for logging, not `println!()`
- Prefer `require!()` or `require_keys_eq!()` for validation
- Always validate account ownership and signer status
- Use `Clock::get()?.unix_timestamp` for time-based logic

### TypeScript/JavaScript
- camelCase for variables, functions
- PascalCase for components, types, interfaces
- Explicit types, avoid `any`
- Use `PublicKey` from `@solana/web3.js` for addresses
- Handle wallet connection states (connecting, connected, disconnected)
- Wrap Solana transactions in try-catch with user-friendly error messages

### React
- Functional components with hooks
- Use `useCallback` for transaction functions to prevent re-renders
- Use `useMemo` for derived state (e.g., calculating rarity display)
- Handle loading and error states explicitly in UI

## Common Workflows

### After Modifying Rust Program
```bash
anchor build                    # Generates IDL and builds program
# Copy IDL to frontend and api if needed
anchor test                     # Run integration tests
```

### After Modifying Frontend
```bash
cd frontend
npm run build                   # Check for TypeScript errors
# Start dev server for manual testing
```

### Deployment Flow
```bash
anchor build
anchor deploy --provider.cluster devnet
npm run initialize              # Initialize program config PDA
# Update NEXT_PUBLIC_PROGRAM_ID in .env files
```

## Critical Configuration

### Environment Variables
Required in root `.env` and `frontend/.env`:
- `NEXT_PUBLIC_PROGRAM_ID` - Deployed program address (from `anchor deploy`)
- `NEXT_PUBLIC_ZEN_MINT` - ZEN token mint address
- `NEXT_PUBLIC_RPC_URL` - Solana RPC endpoint (devnet/mainnet)

### Anchor.toml
- `[programs.localnet]` and `[programs.devnet]` define program IDs
- `[provider]` sets default cluster and wallet path
- Must match program ID in `lib.rs` `declare_id!()` macro

## Testing Conventions

- Integration tests in `tests/integration/` use Anchor test framework
- Test full instruction flows, not individual functions
- Use `anchor.workspace.Zenbeasts` to get program instance
- Create test wallets with `anchor.web3.Keypair.generate()`
- Airdrop SOL for transaction fees in tests
- Verify account state changes after each instruction

## Common Pitfalls to Avoid

- Don't forget to copy updated IDL to `frontend/src/lib/anchor/idl.json` after `anchor build`
- Don't use `cd` commands in scripts; use `path` parameter instead
- Don't hardcode program IDs; use environment variables
- Don't skip account validation in Anchor instructions
- Don't forget cooldown checks for time-gated operations
- Don't use `require` in API code; it uses ES modules
- Always check wallet connection before attempting transactions
