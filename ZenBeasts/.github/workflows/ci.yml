# ============================================================================
# ZenBeasts - CI/CD Pipeline
# GitHub Actions workflow for automated testing, building, and deployment
# ============================================================================

name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - develop
      - 'feature/**'
      - 'hotfix/**'
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:
    inputs:
      deploy_environment:
        description: 'Environment to deploy to'
        required: false
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18'
  RUST_VERSION: 'stable'
  SOLANA_VERSION: '1.17.0'

# Concurrency: cancel in-progress runs on same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ==========================================================================
  # Code Quality & Linting
  # ==========================================================================
  lint:
    name: Code Quality
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install Python linting tools
        run: |
          pip install --upgrade pip
          pip install black flake8 mypy pylint isort bandit

      - name: Run Black (code formatter)
        run: |
          cd bot-hub
          black --check --diff .

      - name: Run Flake8 (style guide)
        run: |
          cd bot-hub
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      - name: Run isort (import sorting)
        run: |
          cd bot-hub
          isort --check-only --diff .

      - name: Run MyPy (type checking)
        run: |
          cd bot-hub
          mypy . --ignore-missing-imports || true

      - name: Run Bandit (security checks)
        run: |
          cd bot-hub
          bandit -r . -f json -o bandit-report.json || true
          bandit -r . || true

      - name: Upload Bandit report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bandit-security-report
          path: bot-hub/bandit-report.json
          retention-days: 30

  # ==========================================================================
  # Python Tests (Bot Hub)
  # ==========================================================================
  test-bot-hub:
    name: Test Bot Hub
    runs-on: ubuntu-latest
    timeout-minutes: 20

    strategy:
      matrix:
        python-version: ['3.10', '3.11', '3.12']

    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: test_zenbeasts
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          cd bot-hub
          pip install --upgrade pip wheel setuptools
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-asyncio pytest-mock

      - name: Run unit tests
        env:
          REDIS_HOST: localhost
          REDIS_PORT: 6379
          POSTGRES_HOST: localhost
          POSTGRES_PORT: 5432
          POSTGRES_DB: test_zenbeasts
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          TEST_MODE: true
        run: |
          cd bot-hub
          pytest tests/ -v -m unit --cov=. --cov-report=xml --cov-report=term-missing

      - name: Run integration tests
        if: matrix.python-version == '3.11'
        env:
          REDIS_HOST: localhost
          REDIS_PORT: 6379
          POSTGRES_HOST: localhost
          POSTGRES_PORT: 5432
          POSTGRES_DB: test_zenbeasts
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          TEST_MODE: true
        run: |
          cd bot-hub
          pytest tests/ -v -m integration --cov=. --cov-report=xml --cov-report=term-missing

      - name: Upload coverage to Codecov
        if: matrix.python-version == '3.11'
        uses: codecov/codecov-action@v4
        with:
          files: ./bot-hub/coverage.xml
          flags: bot-hub
          name: bot-hub-coverage
          fail_ci_if_error: false

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-python-${{ matrix.python-version }}
          path: bot-hub/htmlcov/
          retention-days: 7

  # ==========================================================================
  # Security Scanning
  # ==========================================================================
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      security-events: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Check for secrets
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        if: github.event_name == 'pull_request'

  # ==========================================================================
  # Build Docker Images
  # ==========================================================================
  build-images:
    name: Build Docker Images
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [lint, test-bot-hub]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'

    strategy:
      matrix:
        service: [bot-hub, frontend, api]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: zenbeasts/${{ matrix.service }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix={{branch}}-

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./${{ matrix.service }}
          file: ./${{ matrix.service }}/Dockerfile
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64

      - name: Scan Docker image
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: zenbeasts/${{ matrix.service }}:${{ github.sha }}
          format: 'table'
          exit-code: '0'
          ignore-unfixed: true
          severity: 'CRITICAL,HIGH'

  # ==========================================================================
  # Deploy to Staging
  # ==========================================================================
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [build-images, security]
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    environment:
      name: staging
      url: https://staging.zenbeasts.io

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Deploy to staging
        run: |
          echo "Deploying to staging environment..."
          # Add your deployment commands here
          # Examples:
          # - AWS ECS deployment
          # - Kubernetes deployment
          # - Docker Compose deployment
          # - Ansible playbook
          echo "Deployment would happen here"

      - name: Run smoke tests
        run: |
          echo "Running smoke tests..."
          # Add smoke test commands
          sleep 5
          curl -f https://staging.zenbeasts.io/health || exit 1

      - name: Notify deployment
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: 'Staging deployment ${{ job.status }}'
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}

  # ==========================================================================
  # Deploy to Production
  # ==========================================================================
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [build-images, security]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment:
      name: production
      url: https://zenbeasts.io

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Create deployment backup
        run: |
          echo "Creating backup before deployment..."
          # Add backup commands

      - name: Deploy to production
        run: |
          echo "Deploying to production environment..."
          # Add your production deployment commands

      - name: Run health checks
        run: |
          echo "Running production health checks..."
          sleep 10
          curl -f https://zenbeasts.io/health || exit 1
          curl -f https://zenbeasts.io/api/health || exit 1

      - name: Run smoke tests
        run: |
          echo "Running production smoke tests..."
          # Add comprehensive smoke tests

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ github.ref }}
          draft: false
          prerelease: false

      - name: Notify deployment
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: 'Production deployment ${{ job.status }}'
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}

  # ==========================================================================
  # Performance Tests
  # ==========================================================================
  performance:
    name: Performance Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run load tests
        run: |
          echo "Running performance tests..."
          # Add load testing tools like:
          # - k6
          # - Apache JMeter
          # - Locust

      - name: Generate performance report
        run: |
          echo "Generating performance report..."

      - name: Upload performance results
        uses: actions/upload-artifact@v4
        with:
          name: performance-results
          path: performance-report.html
          retention-days: 30

  # ==========================================================================
  # Documentation
  # ==========================================================================
  docs:
    name: Build Documentation
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install documentation tools
        run: |
          pip install mkdocs mkdocs-material

      - name: Build documentation
        run: |
          echo "Building documentation..."
          # mkdocs build

      - name: Deploy to GitHub Pages
        if: github.ref == 'refs/heads/main'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./site

  # ==========================================================================
  # Cleanup
  # ==========================================================================
  cleanup:
    name: Cleanup
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [deploy-staging, deploy-production]
    if: always()

    steps:
      - name: Clean up old artifacts
        uses: c-hive/gha-remove-artifacts@v1
        with:
          age: '7 days'
          skip-recent: 5

      - name: Clean up old Docker images
        run: |
          echo "Cleaning up old Docker images..."
          # Add cleanup commands for Docker registry

# ============================================================================
# Workflow Status Notifications
# ============================================================================
  notify:
    name: Notify Status
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [lint, test-bot-hub, security, build-images]
    if: always()

    steps:
      - name: Send Discord notification
        uses: sarisia/actions-status-discord@v1
        if: always()
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_URL }}
          status: ${{ job.status }}
          title: "CI/CD Pipeline"
          description: "Build ${{ github.run_number }} completed"
          color: 0x00ff00

      - name: Send Slack notification
        uses: 8398a7/action-slack@v3
        if: always()
        with:
          status: custom
          fields: workflow,job,commit,repo,ref,author,took
          custom_payload: |
            {
              text: `CI/CD Pipeline ${process.env.AS_WORKFLOW} ${process.env.AS_JOB} completed with status: ${process.env.AS_STATUS}`,
              attachments: [{
                color: process.env.AS_STATUS === 'success' ? 'good' : 'danger',
                fields: [{
                  title: 'Repository',
                  value: process.env.AS_REPO,
                  short: true
                }, {
                  title: 'Branch',
                  value: process.env.AS_REF,
                  short: true
                }]
              }]
            }
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}

# ============================================================================
# Notes:
#
# Required Secrets:
# - DOCKER_USERNAME: Docker Hub username
# - DOCKER_PASSWORD: Docker Hub password
# - AWS_ACCESS_KEY_ID: AWS access key for deployment
# - AWS_SECRET_ACCESS_KEY: AWS secret key for deployment
# - SLACK_WEBHOOK_URL: Slack webhook for notifications
# - DISCORD_WEBHOOK_URL: Discord webhook for notifications
#
# Optional Secrets:
# - CODECOV_TOKEN: Codecov token for coverage reports
# - SONAR_TOKEN: SonarCloud token for code quality
#
# Environments:
# - staging: Staging environment with approvers
# - production: Production environment with required approvers
#
# ============================================================================
